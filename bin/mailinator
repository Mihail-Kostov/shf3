#!/bin/bash

prerun="torto -x"
gpg_opt=-z9

function help/mailinator() {
  cat <<EOF
Usage:
  mailinator [ID] [FILE]
EOF
  exit 1
}

# TODO: osx vs linux
function mailinator/id() {
  date +%s | shasum | base64 | head -c 8
}

function __mailinator/id() {
  local l=${1:-6}
  [ "$l" == "" ] && l=16
  tr -dc a-zA-Z0-9 < /dev/urandom | head -c ${l} | xargs
}

function mailinator/gpg() {
  local _f=${1:--}
  gpg ${gpg_opt} -c -o - ${_f} | \
  ascii85
}

function mailinator/decode() {
  echo "$*" | \
  ascii85 -d | \
  gpg 2> /dev/null
}

cmd=${1}
case "${cmd}" in
  help)
    help/mailinator
  ;;
  decode)
    shift
    mailinator/decode $*
    exit 0
  ;;
esac

# TODO: rapidify check

id=${1:-$(mailinator/id)}
inp=${2:--}
to="${id}@mailinator.com"
read -p "Send mail to: ${to}?"
mailinator/gpg ${inp} | \
${prerun} mixminion send -Q -t ${to}
# ${prerun} mail -v -s "mailinator" ${to}
