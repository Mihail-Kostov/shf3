How to build a VirtualBox mini cluster

For real infrastructure:
------------------------------------------------------------------------
http://xcat.sourceforge.net
MAAS/cobbler/OpenStack/JuJu
http://www.sgi.com/products/software/smc.html

Abbreviations:
------------------------------------------------------------------------
H (host):  OS X
A (admin): Ubuntu head node
C (compute): Ubuntu compute nodes

H constitutes eg. the IPMI network

Operator user/pass: op/operator


Installation:
------------------------------------------------------------------------
1.1 Install Ubuntu admin server
  Name: vadmin
  IPMI-like : Adapter 1: Host-only adapter, 'vboxnet1'
  World 1   : Adapter 2: Bridged adapter, en0: Ethernet
  World 2   : Adapter 3: Bridged adapter, en1: AirPort
  Mgmnt     : Adapter 4: Internal network, 'intnet'

  /etc/network/interfaces:
  $HOME/shf3/etc/network/interfaces

  Enable SSH Server at install

  A$ git clone git://github.com/hornos/shf3.git
  $HOME/.profile:
  source $HOME/shf3/bin/shfrc


1.2 Install VirtualBox Additions:
  A$ sudo apt-get install -y dkms build-essential linux-headers-generic linux-headers-$(uname -r)
  A$ sudo mount /dev/cdrom /media/cdrom
  A$ sudo /media/cdrom/VBoxLinuxAdditions.run


1.3 Install Ubuntu compute node seed or clone vadmin
  http://www.orzeszek.org/blog/2010/07/25/fix-missing-eth0-when-cloning-ubuntu-vmware-virtual-machines/

  Name: vm1
  (Install VirtualBox Additions)

  H$ gmgr start seed

  H$ sshin vm1
  /etc/sudoers.d/operator:
  op ALL=(ALL) NOPASSWD: ALL

  C$ sudo chmod 0440 /etc/sudoers.d/operator
  C$ sudo chown root.root /etc/sudoers.d/operator
  C$ sudo rm /etc/udev/rules.d/70-persistent-net.rules
  C$ sudo rm /var/lib/dhcp/dhclient.*
  C$ echo "hostname \$new_host_name" | sudo tee /etc/dhcp/dhclient-exit-hooks.d/hostname

  /etc/dhcp/dhclient.conf:
  prepend domain-name-servers 10.10.10.10

  H$ gmgr stop seed


1.4 Clone N-1 compute nodes from the seed
  H$ gmgr clone vm1 3
  (Optionally make a backup clone of vm1 with th GUI)


1.5 Set DHCP on vadmin
  http://www.techrepublic.com/blog/opensource/using-dnsmasq-for-dns-and-dhcp-services/293
  /etc/dnsmasq.conf:
  interface=eth3
  bind-interfaces
  dhcp-range=10.10.10.11,10.10.10.254
  dhcp-option=3
  dhcp-option=6,10.10.10.10
  dhcp-lease-max=1000
  dhcp-authoritative
  address=/vadmin/10.10.10.10 

  A$ sudo chown -R op.root /etc/dnsmasq.d


2.1 Set genders on the Host
  https://computing.llnl.gov/linux/genders.html
  $HOME/shf3/mid/grid/default:
  vadmin  admin,all
  vm[1-3] compute,all


2.2 DHCP/DNS for compute nodes
  H$ gmgr dnsmasq
  H$ gmgr start compute
  H$ gmgr sshkey compute

# parallel ssh

2.4 Chef
  http://generalthings.com/2012/05/08/simple-steps-install-chef-ubuntu-12-04-10-04/
  H$ gmgr ifup eth2 compute

  H$ sshtx put vadmin /Users/mighty/shf3/etc/install_chef_server
  H$ sshexec vadmin ./install_chef_server
  H$ sudo gem install chef


  H$ gmgr chef bootstrap 2 compute
  H$ gmgr stop/start compute

  # ufw
  # syslog-ng/scribe
  # ganglia cerebro
  # mysql/postgres-xc cluster
  # slurm/mpi
  # hadoop/hdfs
  # mongodb
  # cache
  # app mon supervisond


  Check IPs of the cluster
  $ gmgr ips
  Start/stop/pause the cluster
  $ gmgr start/stop/pause
  Check load
  $ gmgr top
